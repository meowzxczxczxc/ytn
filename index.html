<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–°–¢–ï–ù–î–û–§ 228 - –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(45deg, #1a1a2e, #16213e, #0f3460);
            color: white;
            font-family: 'Arial', sans-serif;
            overflow: hidden;
        }

        .game-container {
            display: grid;
            grid-template-columns: 1fr 300px;
            height: 100vh;
            gap: 10px;
            padding: 10px;
        }

        #gameCanvas {
            background: linear-gradient(180deg, #000428, #004e92);
            border-radius: 15px;
            border: 3px solid #00ff88;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .players-list {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #4ecdc4;
            flex: 1;
        }

        .chat-container {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 15px;
            border: 2px solid #ff6b6b;
            display: flex;
            flex-direction: column;
            height: 300px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .chat-input {
            display: flex;
            gap: 5px;
        }

        .chat-input input {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 8px;
            background: rgba(255,255,255,0.9);
        }

        .chat-input button {
            padding: 8px 15px;
            background: #4ecdc4;
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
        }

        .player-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
        }

        .health-bar {
            width: 60px;
            height: 8px;
            background: rgba(255,0,0,0.3);
            border-radius: 4px;
            overflow: hidden;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc66);
            transition: width 0.3s;
        }

        .connection-status {
            position: fixed;
            top: 10px;
            left: 10px;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
        }

        .connected {
            background: rgba(0,255,136,0.3);
            border: 2px solid #00ff88;
        }

        .disconnected {
            background: rgba(255,107,107,0.3);
            border: 2px solid #ff6b6b;
        }

        .game-title {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">
        –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
    </div>

    <div class="game-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        
        <div class="sidebar">
            <div class="players-list">
                <div class="game-title">–°–¢–ï–ù–î–û–§ 228</div>
                <div>–û–Ω–ª–∞–π–Ω: <span id="onlineCount">0</span></div>
                <div id="playersList"></div>
            </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages"></div>
                <div class="chat-input">
                    <input type="text" id="chatInput" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="100">
                    <button onclick="sendMessage()">–û—Ç–ø—Ä.</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class MultiplayerGame {
            constructor() {
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.connectionStatus = document.getElementById('connectionStatus');
                this.playersList = document.getElementById('playersList');
                this.chatMessages = document.getElementById('chatMessages');
                this.onlineCount = document.getElementById('onlineCount');
                
                this.ws = null;
                this.playerId = null;
                this.players = new Map();
                this.bullets = [];
                this.powerUps = [];
                this.keys = {};
                
                this.connect();
                this.setupEventListeners();
                this.gameLoop();
            }
            
            connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}`;
                
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    this.connectionStatus.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                    this.connectionStatus.className = 'connection-status connected';
                };
                
                this.ws.onclose = () => {
                    this.connectionStatus.textContent = '‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ';
                    this.connectionStatus.className = 'connection-status disconnected';
                    
                    // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                    setTimeout(() => this.connect(), 3000);
                };
                
                this.ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };
            }
            
            handleMessage(data) {
                switch (data.type) {
                    case 'welcome':
                        this.playerId = data.playerId;
                        break;
                        
                    case 'gameState':
                        this.players = new Map(data.players.map(p => [p.id, p]));
                        this.bullets = data.bullets;
                        this.powerUps = data.powerUps;
                        this.updatePlayersList();
                        break;
                        
                    case 'playerJoined':
                        this.addChatMessage('‚ö°', `${data.player.name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∏–≥—Ä–µ`);
                        break;
                        
                    case 'playerLeft':
                        this.addChatMessage('üëã', '–ò–≥—Ä–æ–∫ –ø–æ–∫–∏–Ω—É–ª –∏–≥—Ä—É');
                        break;
                        
                    case 'playerKilled':
                        const killer = this.players.get(data.killer)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                        const victim = this.players.get(data.victim)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
                        this.addChatMessage('üíÄ', `${killer} —É–Ω–∏—á—Ç–æ–∂–∏–ª ${victim}! +100 –æ—á–∫–æ–≤`);
                        break;
                        
                    case 'chat':
                        this.addChatMessage(data.playerName, data.message);
                        break;
                }
            }
            
            updatePlayersList() {
                this.onlineCount.textContent = this.players.size;
                
                this.playersList.innerHTML = '';
                this.players.forEach(player => {
                    const playerElement = document.createElement('div');
                    playerElement.className = 'player-item';
                    playerElement.innerHTML = `
                        <div>
                            <strong>${player.name}</strong>
                            <div>–û—á–∫–∏: ${player.score}</div>
                        </div>
                        <div>
                            <div class="health-bar">
                                <div class="health-fill" style="width: ${player.health}%"></div>
                            </div>
                        </div>
                    `;
                    this.playersList.appendChild(playerElement);
                });
            }
            
            addChatMessage(sender, message) {
                const messageElement = document.createElement('div');
                messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
                this.chatMessages.appendChild(messageElement);
                this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
            }
            
            setupEventListeners() {
                document.addEventListener('keydown', (e) => {
                    this.keys[e.key] = true;
                    
                    if (e.key === ' ') {
                        this.shoot();
                        e.preventDefault();
                    }
                    
                    if (e.key === 'Enter') {
                        document.getElementById('chatInput').focus();
                        e.preventDefault();
                    }
                });
                
                document.addEventListener('keyup', (e) => {
                    this.keys[e.key] = false;
                });
                
                // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ Enter
                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendMessage();
                    }
                });
            }
            
            update() {
                if (!this.playerId || !this.players.has(this.playerId)) return;
                
                const player = this.players.get(this.playerId);
                let moved = false;
                
                if (this.keys['ArrowLeft'] || this.keys['a']) {
                    player.x -= 5;
                    moved = true;
                }
                if (this.keys['ArrowRight'] || this.keys['d']) {
                    player.x += 5;
                    moved = true;
                }
                if (this.keys['ArrowUp'] || this.keys['w']) {
                    player.y -= 5;
                    moved = true;
                }
                if (this.keys['ArrowDown'] || this.keys['s']) {
                    player.y += 5;
                    moved = true;
                }
                
                // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–≤–∏–∂–µ–Ω–∏—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö canvas
                player.x = Math.max(0, Math.min(this.canvas.width - player.width, player.x));
                player.y = Math.max(0, Math.min(this.canvas.height - player.height, player.y));
                
                if (moved && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'move',
                        x: player.x,
                        y: player.y
                    }));
                }
            }
            
            shoot() {
                if (this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'shoot'
                    }));
                }
            }
            
            draw() {
                // –û—á–∏—Å—Ç–∫–∞ canvas
                this.ctx.fillStyle = 'rgba(0, 4, 40, 0.1)';
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
                
                // –†–∏—Å–æ–≤–∞–Ω–∏–µ –∏–≥—Ä–æ–∫–æ–≤
                this.players.forEach(player => {
                    this.drawPlayer(player);
                    
                    // –ò–º—è –∏–≥—Ä–æ–∫–∞
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.fillText(player.name, player.x + player.width / 2, player.y - 10);
                    
                    // –ü–æ–ª–æ—Å–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è
                    this.ctx.fillStyle = 'red';
                    this.ctx.fillRect(player.x, player.y - 5, player.width, 3);
                    this.ctx.fillStyle = 'lime';
                    this.ctx.fillRect(player.x, player.y - 5, player.width * (player.health / 100), 3);
                });
                
                // –†–∏—Å–æ–≤–∞–Ω–∏–µ –ø—É–ª—å
                this.bullets.forEach(bullet => {
                    this.ctx.fillStyle = bullet.color;
                    this.ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
                });
                
                // –†–∏—Å–æ–≤–∞–Ω–∏–µ –±–æ–Ω—É—Å–æ–≤
                this.powerUps.forEach(powerUp => {
                    this.ctx.fillStyle = powerUp.type === 'health' ? '#00ff88' : '#ffaa00';
                    this.ctx.beginPath();
                    this.ctx.arc(powerUp.x + powerUp.width / 2, powerUp.y + powerUp.height / 2, powerUp.width / 2, 0, Math.PI * 2);
                    this.ctx.fill();
                    
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '12px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(powerUp.type === 'health' ? '‚ô•' : '+50', powerUp.x + powerUp.width / 2, powerUp.y + powerUp.height / 2);
                });
            }
            
            drawPlayer(player) {
                this.ctx.fillStyle = player.color;
                
                // –ö–æ—Ä–∞–±–ª—å –∏–≥—Ä–æ–∫–∞
                this.ctx.beginPath();
                this.ctx.moveTo(player.x + player.width / 2, player.y);
                this.ctx.lineTo(player.x, player.y + player.height);
                this.ctx.lineTo(player.x + player.width, player.y + player.height);
                this.ctx.closePath();
                this.ctx.fill();
                
                // –í—ã–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞
                if (player.id === this.playerId) {
                    this.ctx.strokeStyle = '#00ff88';
                    this.ctx.lineWidth = 3;
                    this.ctx.stroke();
                }
            }
            
            gameLoop() {
                this.update();
                this.draw();
                requestAnimationFrame(() => this.gameLoop());
            }
        }
        
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (message && game.ws.readyState === WebSocket.OPEN) {
                game.ws.send(JSON.stringify({
                    type: 'chat',
                    message: message
                }));
                input.value = '';
            }
            
            input.focus();
        }
        
        // –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã
        const game = new MultiplayerGame();
    </script>
</body>
</html>
